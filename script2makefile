#!/usr/bin/make

__SCRIPTDIR := recipe.d
__FRAGDIR := recipe.mk
__RCFILE := ./scripts.rc

__SCRIPTS := $(sort $(wildcard ${__SCRIPTDIR}/*[0-9A-Za-z]))
__FRAGS := $(addsuffix .mk,$(addprefix ${__FRAGDIR}/,$(notdir $(__SCRIPTS))))

${__FRAGDIR}/%.mk : ${__SCRIPTDIR}/%
	@( \
	  if grep '^#skip' $< >/dev/null ; then true; else \
	  deps=`grep '^#requires ' $< | sed 's@#requires @done\/@'` ;\
	  deps=`echo $$deps` ;\
	  base=`echo $* | sed 's/^[0-9][0-9][0-9][0-9]-//'` ;\
	  echo __TARGETS += done/$$base ;\
	  echo ".PHONY: $$base" ;\
	  echo "$$base : done/$$base" ;\
	  echo "	@true" ;\
	  echo "done/$$base : $$deps" ;\
	  echo "	@echo " ;\
	  echo "	@echo Building $$base" ;\
	  echo "	@echo " ;\
	  echo "	@bash --rcfile ${__RCFILE} -i -e ${__SCRIPTDIR}/$*" ;\
	  echo "	@true > done/$$base" ;\
	  fi \
	) > $@

all.first : all.targets
	@true

__TARGETS :=

include ${__FRAGS}

all.targets : ${__TARGETS}
	@echo
	@echo 'done!'
